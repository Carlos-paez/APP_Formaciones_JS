<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diagn√≥stico de Base de Datos</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #2c5282;
        margin-bottom: 30px;
      }
      .section {
        margin-bottom: 30px;
        padding: 20px;
        border-radius: 8px;
        border-left: 5px solid #2c5282;
      }
      .success {
        background: #d4edda;
        border-left-color: #28a745;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border-left-color: #dc3545;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        border-left-color: #17a2b8;
        color: #0c5460;
      }
      .warning {
        background: #fff3cd;
        border-left-color: #ffc107;
        color: #856404;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background: #2c5282;
        color: white;
      }
      tr:hover {
        background: #f5f5f5;
      }
      .btn {
        display: inline-block;
        padding: 10px 20px;
        margin: 5px;
        background: #2c5282;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-weight: bold;
        border: none;
        cursor: pointer;
      }
      .btn:hover {
        background: #1a365d;
      }
      .btn-danger {
        background: #dc3545;
      }
      .btn-danger:hover {
        background: #c82333;
      }
      pre {
        background: #1e1e1e;
        color: #00ff00;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
      }
      .test-result {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-weight: bold;
      }
      .test-pass {
        background: #d4edda;
        color: #155724;
      }
      .test-fail {
        background: #f8d7da;
        color: #721c24;
      }
      #log {
        background: #1e1e1e;
        color: #00ff00;
        padding: 15px;
        border-radius: 5px;
        font-family: "Courier New", monospace;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üî¨ Diagn√≥stico Completo de Base de Datos</h1>

      <div id="systemInfo" class="section info">
        <h2>üìä Informaci√≥n del Sistema</h2>
        <p>Cargando informaci√≥n del sistema...</p>
      </div>

      <div id="dbInfo" class="section info">
        <h2>üíæ Informaci√≥n de la Base de Datos</h2>
        <p>Cargando informaci√≥n de la base de datos...</p>
      </div>

      <div id="eventsSection" class="section info">
        <h2>üìà Estad√≠sticas de Eventos</h2>
        <p>Cargando eventos...</p>
      </div>

      <div id="testSection" class="section">
        <h2>üß™ Prueba de Eliminaci√≥n</h2>
        <div id="testForm"></div>
      </div>

      <div class="section">
        <h2>üîß Acciones</h2>
        <a href="index.html" class="btn">üè† Volver al Inicio</a>
        <a href="register.html" class="btn">üìù Registrar Evento</a>
        <a href="events.html" class="btn">üìã Ver Eventos</a>
        <button class="btn" onclick="location.reload()">
          üîÑ Recargar Diagn√≥stico
        </button>
      </div>

      <div class="section">
        <h2>üì° Log de Operaciones</h2>
        <div id="log"></div>
      </div>
    </div>

    <script>
      const logElement = document.getElementById("log");

      function log(message, type = "info") {
        const emoji =
          {
            info: "‚ÑπÔ∏è",
            success: "‚úÖ",
            error: "‚ùå",
            warning: "‚ö†Ô∏è",
          }[type] || "‚ÑπÔ∏è";

        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `[${timestamp}] ${emoji} ${message}\n`;

        logElement.textContent += logMessage;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
      }

      async function loadSystemInfo() {
        try {
          const response = await fetch("/package.json");
          const packageJson = await response.json();

          const systemInfo = document.getElementById("systemInfo");
          systemInfo.innerHTML = `
                    <h2>üìä Informaci√≥n del Sistema</h2>
                    <p><strong>Node.js Version:</strong> ${process.version || "N/A"}</p>
                    <p><strong>App Version:</strong> ${packageJson.version}</p>
                    <p><strong>Nombre:</strong> ${packageJson.name}</p>
                    <p><strong>Directorio actual:</strong> ${window.location.origin}</p>
                `;

          log("Informaci√≥n del sistema cargada", "success");
        } catch (error) {
          log(
            "Error cargando informaci√≥n del sistema: " + error.message,
            "error",
          );
        }
      }

      async function loadDatabaseInfo() {
        try {
          const response = await fetch("/api/events");
          const events = await response.json();

          const stats = await fetch("/api/stats")
            .then((r) => r.json())
            .catch(() => ({}));

          const dbInfo = document.getElementById("dbInfo");
          dbInfo.innerHTML = `
                    <h2>üíæ Informaci√≥n de la Base de Datos</h2>
                    <p><strong>Base de datos:</strong> events.db (SQLite)</p>
                    <p><strong>Estado:</strong> ‚úÖ Conectada</p>
                    <p><strong>Total de eventos:</strong> ${events.length}</p>
                `;

          log(
            `Base de datos cargada. ${events.length} eventos encontrados`,
            "success",
          );

          loadEvents(events);
        } catch (error) {
          log(
            "Error cargando informaci√≥n de la base de datos: " + error.message,
            "error",
          );
        }
      }

      function loadEvents(events) {
        const eventsSection = document.getElementById("eventsSection");

        if (events.length === 0) {
          eventsSection.innerHTML = `
                    <h2>üìà Estad√≠sticas de Eventos</h2>
                    <div class="warning">
                        <h3>‚ö†Ô∏è No hay eventos en la base de datos</h3>
                        <p>La base de datos est√° vac√≠a. Registra un evento para comenzar.</p>
                    </div>
                `;
          document.getElementById("testSection").style.display = "none";
          return;
        }

        let tableHTML = `
                <h2>üìã Eventos Registrados</h2>
                <table>
                    <tr>
                        <th>ID</th>
                        <th>Ubicaci√≥n</th>
                        <th>Formador</th>
                        <th>Hora Inicio</th>
                        <th>Hora Fin</th>
                        <th>Creado</th>
                        <th>Acciones</th>
                    </tr>
            `;

        events.forEach((event) => {
          tableHTML += `
                    <tr>
                        <td><strong>${event.id}</strong></td>
                        <td>${escapeHtml(event.ubicacion)}</td>
                        <td>${escapeHtml(event.formador)}</td>
                        <td>${event.hora_inicio}</td>
                        <td>${event.hora_fin}</td>
                        <td>${new Date(event.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteEvent(${event.id})">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                `;
        });

        tableHTML += `</table>`;
        eventsSection.innerHTML = tableHTML;

        // Cargar formulario de prueba
        loadTestForm(events);
      }

      function loadTestForm(events) {
        const testForm = document.getElementById("testForm");

        let optionsHTML = "";
        events.forEach((event) => {
          optionsHTML += `<option value="${event.id}">ID ${event.id}: ${event.ubicacion} - ${event.formador}</option>`;
        });

        testForm.innerHTML = `
                <p>Selecciona un evento para probar la eliminaci√≥n:</p>
                <select id="testEventSelect" class="btn">
                    ${optionsHTML}
                </select>
                <button class="btn btn-danger" onclick="testDelete()">
                    üß™ Probar Eliminaci√≥n
                </button>
                <div id="testResult"></div>
            `;
      }

      async function testDelete() {
        const eventId = document.getElementById("testEventSelect").value;
        const resultDiv = document.getElementById("testResult");

        if (
          !confirm(
            `¬øRealmente quieres probar eliminar el evento ID ${eventId}?`,
          )
        ) {
          return;
        }

        resultDiv.innerHTML = "<p>Eliminando evento...</p>";
        log(`Probando eliminaci√≥n del evento ID ${eventId}`, "info");

        try {
          const response = await fetch(`/api/events/${eventId}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            resultDiv.innerHTML = `
                        <div class="test-result test-pass">
                            ‚úÖ ${result.message}<br>
                            <strong>ID eliminado:</strong> ${result.deleted_id}<br>
                            <strong>Filas afectadas:</strong> ${result.rows_affected}
                        </div>
                    `;
            log(`Evento ID ${eventId} eliminado correctamente`, "success");

            // Recargar despu√©s de 2 segundos
            setTimeout(() => {
              location.reload();
            }, 2000);
          } else {
            resultDiv.innerHTML = `
                        <div class="test-result test-fail">
                            ‚ùå ${result.message}
                        </div>
                    `;
            if (result.available_ids) {
              resultDiv.innerHTML += `<p><strong>IDs disponibles:</strong> ${result.available_ids.join(", ")}</p>`;
            }
            log(`Error eliminando evento: ${result.message}`, "error");
          }
        } catch (error) {
          resultDiv.innerHTML = `
                    <div class="test-result test-fail">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
          log("Error en prueba de eliminaci√≥n: " + error.message, "error");
        }
      }

      async function deleteEvent(eventId) {
        if (!confirm(`¬øEliminar evento ID ${eventId}?`)) return;

        try {
          const response = await fetch(`/api/events/${eventId}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            alert("‚úÖ Evento eliminado correctamente");
            location.reload();
          } else {
            alert("‚ùå " + result.message);
          }
        } catch (error) {
          alert("‚ùå Error al eliminar: " + error.message);
        }
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Cargar todo al iniciar
      window.addEventListener("DOMContentLoaded", () => {
        log("=== INICIANDO DIAGN√ìSTICO ===", "info");
        loadSystemInfo();
        loadDatabaseInfo();
      });
    </script>
  </body>
</html>
